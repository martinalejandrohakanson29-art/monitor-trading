<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estrategia Muro + Martillo | V2.0</title>
    <script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { background-color: #0e0e10; color: #d1d4dc; font-family: sans-serif; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
        .dashboard-header { display: flex; padding: 10px 20px; background: #181b21; border-bottom: 1px solid #2a2e39; gap: 15px; flex-wrap: wrap; justify-content: space-between; align-items: center;}
        .metric-card { background: #222631; padding: 10px 15px; border-radius: 6px; min-width: 140px; display: flex; flex-direction: column; justify-content: center; }
        .metric-title { font-size: 11px; color: #848e9c; text-transform: uppercase; font-weight: 600; margin-bottom: 4px; }
        .metric-value { font-size: 18px; font-weight: bold; letter-spacing: 0.5px; }
        .metric-sub { font-size: 11px; margin-top: 2px; opacity: 0.8; }
        .color-up { color: #0ecb81; } 
        .color-down { color: #f6465d; } 
        .color-neutral { color: #d1d4dc; }
        #chart-container { flex-grow: 1; width: 100%; position: relative; }
        #debug-console { padding: 5px; font-size: 10px; color: #555; background: #000; text-align: center; }
    </style>
</head>
<body>

    <div class="dashboard-header">
        <div style="display:flex; align-items:center;">
            <span style="font-weight:bold; font-size:14px; color: gold;">BTC/USDT</span>
        </div>

        <div class="metric-card">
            <span class="metric-title">Precio Actual</span>
            <span class="metric-value" id="price">---</span>
        </div>

        <div class="metric-card">
            <span class="metric-title">Presión (Trades)</span>
            <span class="metric-value" id="pressure-val">---%</span>
            <span class="metric-sub" id="pressure-text">Esperando datos...</span>
        </div>

        <div class="metric-card" style="border-bottom: 2px solid #0ecb81;">
            <span class="metric-title">Muro Compras</span>
            <span class="metric-value color-up" id="wall-buy-price">---</span>
            <span class="metric-sub" id="wall-buy-vol">---</span>
        </div>

        <div class="metric-card" style="border-bottom: 2px solid #f6465d;">
            <span class="metric-title">Muro Ventas</span>
            <span class="metric-value color-down" id="wall-sell-price">---</span>
            <span class="metric-sub" id="wall-sell-vol">---</span>
        </div>
    </div>

    <div id="chart-container"></div>
    <div id="debug-console">Inicializando sistema...</div>

    <script>
        // --- FUNCIÓN DE DEBUGGING ---
        function logStatus(msg) {
            document.getElementById('debug-console').innerText = msg;
            console.log(msg);
        }

        // --- VERIFICAR LIBRERÍA ---
        if (typeof LightweightCharts === 'undefined') {
            logStatus("ERROR CRÍTICO: La librería de gráficos no cargó. Revisa tu conexión.");
        } else {
            initChart();
        }

        function initChart() {
            logStatus("Iniciando gráficos...");
            
            const domElement = document.getElementById('chart-container');
            const chart = LightweightCharts.createChart(domElement, {
                layout: { background: { color: '#0e0e10' }, textColor: '#848e9c' },
                grid: { vertLines: { color: '#1e222d' }, horzLines: { color: '#1e222d' } },
                timeScale: { timeVisible: true, secondsVisible: false },
            });

            const candleSeries = chart.addCandlestickSeries({
                upColor: '#0ecb81', downColor: '#f6465d', borderDownColor: '#f6465d', borderUpColor: '#0ecb81',
            });

            // Variables para muros
            let buyWallLine = null;
            let sellWallLine = null;

            window.addEventListener('resize', () => { chart.resize(domElement.clientWidth, domElement.clientHeight); });

            // 1. CARGAR HISTORIAL
            fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=100')
                .then(res => res.json())
                .then(data => {
                    logStatus("Historial cargado. Conectando WebSocket...");
                    const candles = data.map(d => ({
                        time: d[0] / 1000,
                        open: parseFloat(d[1]), high: parseFloat(d[2]), low: parseFloat(d[3]), close: parseFloat(d[4])
                    }));
                    candleSeries.setData(candles);
                    startWebSocket(); // Iniciar tiempo real solo si carga el historial
                })
                .catch(err => {
                    logStatus("Error cargando historial (CORS o Red). Intentando conexión directa...");
                    startWebSocket(); // Intentar conectar aunque falle el historial
                });

            // 2. WEBSOCKET (TIEMPO REAL)
            function startWebSocket() {
                const ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@kline_1m');
                
                ws.onopen = () => { logStatus("Sistema Online - Recibiendo datos de Binance"); };
                
                ws.onmessage = (event) => {
                    const msg = JSON.parse(event.data);
                    const k = msg.k;
                    candleSeries.update({
                        time: k.t / 1000,
                        open: parseFloat(k.o), high: parseFloat(k.h), low: parseFloat(k.l), close: parseFloat(k.c)
                    });
                    document.getElementById('price').innerText = parseFloat(k.c).toFixed(2);
                };
            }

        // 3. ANÁLISIS DE DATOS V3 (AGRUPACIÓN POR ZONAS/BUCKETS)
            setInterval(async () => {
                try {
                    // A. ORDER BOOK (Traemos MUCHA profundidad para ver el panorama completo)
                    const depthRes = await fetch('https://api.binance.com/api/v3/depth?symbol=BTCUSDT&limit=5000'); // Max profundidad
                    const depth = await depthRes.json();
                    
                    // CONFIGURACIÓN:
                    const BIN_SIZE = 50; // Agrupamos órdenes en bloques de $50 USD
                    
                    // Función para agrupar volumen en bloques
                    function findBiggestWall(orders, isAsk) {
                        let buckets = {};
                        let maxVol = 0;
                        let maxPriceLevel = 0;

                        orders.forEach(order => {
                            let price = parseFloat(order[0]);
                            let vol = parseFloat(order[1]);
                            
                            // Truco matemático: Redondear al bloque de 50 más cercano
                            // Ej: 90012 -> 90000 | 90048 -> 90000 | 90051 -> 90050
                            let bucketPrice = Math.floor(price / BIN_SIZE) * BIN_SIZE;
                            
                            if(!buckets[bucketPrice]) buckets[bucketPrice] = 0;
                            buckets[bucketPrice] += vol;
                            
                            if(buckets[bucketPrice] > maxVol) {
                                maxVol = buckets[bucketPrice];
                                maxPriceLevel = bucketPrice;
                            }
                        });
                        return { p: maxPriceLevel, v: maxVol };
                    }

                    // Calculamos los muros basados en zonas acumuladas
                    // Nota: depth.bids son compras, depth.asks son ventas
                    let wallBuy = findBiggestWall(depth.bids, false);
                    let wallSell = findBiggestWall(depth.asks, true);

                    // Actualizar Panel
                    document.getElementById('wall-buy-price').innerText = wallBuy.p.toFixed(0); // Sin decimales, es una zona
                    document.getElementById('wall-buy-vol').innerText = wallBuy.v.toFixed(1) + " BTC";
                    document.getElementById('wall-sell-price').innerText = wallSell.p.toFixed(0);
                    document.getElementById('wall-sell-vol').innerText = wallSell.v.toFixed(1) + " BTC";

                    // Dibujar lineas
                    if(buyWallLine) candleSeries.removePriceLine(buyWallLine);
                    if(sellWallLine) candleSeries.removePriceLine(sellWallLine);
                    
                    // Solo dibujamos si el muro es relevante (> 10 BTC para filtrar basura)
                    if (wallBuy.v > 10) {
                        buyWallLine = candleSeries.createPriceLine({ 
                            price: wallBuy.p, color: '#0ecb81', lineWidth: 3, lineStyle: 0, 
                            title: `ZONA COMPRA (${wallBuy.v.toFixed(0)} BTC)` 
                        });
                    }
                    if (wallSell.v > 10) {
                        sellWallLine = candleSeries.createPriceLine({ 
                            price: wallSell.p, color: '#f6465d', lineWidth: 3, lineStyle: 0, 
                            title: `ZONA VENTA (${wallSell.v.toFixed(0)} BTC)` 
                        });
                    }

                    // B. PRESIÓN (Trades) - Esto sigue igual, es el pulso del mercado
                    const tradesRes = await fetch('https://api.binance.com/api/v3/trades?symbol=BTCUSDT&limit=1000');
                    const trades = await tradesRes.json();
                    
                    let buyVol = 0, sellVol = 0;
                    trades.forEach(t => {
                        let val = parseFloat(t.qty) * parseFloat(t.price);
                        if(t.isBuyerMaker === false) buyVol += val; else sellVol += val;
                    });
                    
                    let pressure = (buyVol / (buyVol + sellVol)) * 100;
                    const pVal = document.getElementById('pressure-val');
                    pVal.innerText = pressure.toFixed(1) + "%";
                    
                    if(pressure > 55) { pVal.className = "metric-value color-up"; document.getElementById('pressure-text').innerText = "ALCISTA"; }
                    else if(pressure < 45) { pVal.className = "metric-value color-down"; document.getElementById('pressure-text').innerText = "BAJISTA"; }
                    else { pVal.className = "metric-value color-neutral"; document.getElementById('pressure-text').innerText = "Neutral"; }

                } catch(e) { console.log(e); }
            }, 4000); // Subimos a 4 segundos para dar tiempo a procesar tanta data
        }
    </script>
</body>
</html>




